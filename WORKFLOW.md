# Beauty Generator V4.0 ULTIMATE 工作流程

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Beauty Generator V4.0 ULTIMATE                        │
│                     美女图像生成系统 - 终极版本                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户输入层                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  自然语言    │  │   命令行     │  │   定时任务   │  │  Claude      │  │
│  │  "每日美女"  │  │   参数控制   │  │   21:00      │  │  Skill 触发  │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              参数控制层 V4.0                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌───────────┐ │
│  │ 场景控制   │ │ 情绪控制   │ │ 妆容控制   │ │ 艺术风格   │ │ 光影控制  │ │
│  │ (15+ 种)   │ │ (8 种)     │ │ (8 种)     │ │ (8 种)     │ │ (8 种)   │ │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘ └───────────┘ │
│         │             │             │             │             │          │
│         └─────────────┴─────────────┴─────────────┴─────────────┘          │
│                                    │                                        │
│                           ┌────────▼────────┐                              │
│                           │ 精准参数合成器  │                              │
│                           └─────────────────┘                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              核心处理层                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                        日期与主题系统                                  │ │
│  │  • 当前日期 → 星期几 → 每周主题 (7种主题轮换)                         │ │
│  │  • 日期种子 → 确保同一天相同人物特征                                   │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                    │                                        │
│                                    ▼                                        │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                        人物档案生成器                                  │ │
│  │  • 面容特征 (根据主题)                                                 │ │
│  │  • 发型风格                                                           │
│  │  • 身材描述                                                           │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                    │                                        │
│                                    ▼                                        │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                     Master Prompt 构建器                               │ │
│  │  • 基础质量词 (masterpiece, 8K, UHD)                                  │ │
│  │  • 艺术风格 + 情绪 + 妆容                                              │ │
│  │  • 主体描述 (面容 + 发型 + 身材)                                        │ │
│  │  • 服装搭配                                                            │
│  │  • 场景描述                                                            │
│  │  • 光影设定                                                            │
│  │  • 相机参数                                                            │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                    │                                        │
│                                    ▼                                        │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                        姿态生成器                                     │ │
│  │  图1: 极致特写 - 正面半身、迷人眼神                                    │ │
│  │  图2: 完美侧颜 - 45度侧颜、回眸瞬间                                    │ │
│  │  图3: 全身魅力 - S曲线、动态抓拍                                        │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             图像生成层                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                      豆包 Seedream API                                │  │
│   │              doubao-seedream-4-5-251128                              │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   ┌────────────────────┐              ┌────────────────────┐               │
│   │    图片 1 生成      │              │    图 2、3 生成     │               │
│   │                    │              │                    │               │
│   │  • 文生图 (TXT2IMG) │              │  • 图生图 (IMG2IMG) │               │
│   │  • prompt → API    │              │  • 参考图1 + prompt │               │
│   │  → 图片URL         │              │  → API → 图片URL   │               │
│   └────────────────────┘              └────────────────────┘               │
│            │                                  │                            │
│            │ 作为参考图                       │                            │
│            └──────────────────┬───────────────┘                            │
│                               │                                           │
│                        ┌──────▼────────┐                                  │
│                        │ 人物一致性保证 │                                  │
│                        │   (图生图技术)  │                                  │
│                        └───────────────┘                                  │
│                                                                             │
│   ⚠️ 图片仅保留在线URL (豆包云)，不保存到本地                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              输出处理层                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ⚠️ 图片仅保留在线URL (豆包云，24小时有效)                                  │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                         公众号发布系统                                │ │
│  │                                                                      │ │
│  │  ┌────────────────────┐              ┌────────────────────┐          │ │
│  │  │     自动发布        │              │     手动发布        │          │ │
│  │  │                    │              │                    │          │ │
│  │  │  • 定时触发         │              │  • 用户主动触发     │          │ │
│  │  │  • 每天 21:00       │              │  • 命令行调用       │          │ │
│  │  │  • launchd 定时     │              │  • Claude Skill    │          │ │
│  │  │                    │              │                    │          │ │
│  │  │  → 生成 3 张图      │              │  → 生成指定数量    │          │ │
│  │  │  → 生成配文         │              │  → [可选] 配文     │          │ │
│  │  │  → 微绿API          │              │  → 微绿API         │          │ │
│  │  │  → 草稿箱           │              │  → 草稿箱          │          │ │
│  │  └────────────────────┘              └────────────────────┘          │ │
│  │                                                                      │ │
│  │  发布格式: 小绿书 (newspic)                                         │ │
│  │  目标公众号: 「三更愿」(wx287cdb9d78a498aa)                        │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 图片持久性说明

```
┌─────────────────────────────────────────────────────────────────────┐
│                     图片生命周期与持久化                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  豆包云URL (生成)                                                   │
│       ↓                                                            │
│  ├─→ 24小时内有效                                                  │
│  │   ↓                                                            │
│  │   微绿API → 微信公众号服务器                                     │
│  │        ↓                                                        │
│  │   微信自动下载 → 微信CDN (永久)                                 │
│  │        ↓                                                        │
│  │   公众号文章指向微信CDN ← 图片永久显示                          │
│  │                                                                 │
│  └─→ 验证测试: python3 ~/.claude/skills/beauty-generator/scripts/  │
│                 test_image_persistence.py --run                    │
│                                                                 │
│  ⚠️ 如果24小时后图片失效 → 需添加图片上传到微信素材库功能           │
│                                                                 │
└─────────────────────────────────────────────────────────────────────┘
```

**测试步骤**:
1. 运行测试: `python3 test_image_persistence.py --run`
2. 25小时后检查: `python3 test_image_persistence.py --check`
3. 到公众号后台查看草稿箱图片是否正常显示

### 1. 用户输入阶段

```
用户 → "每日美女" 或 "发布美女" 或参数控制
  │
  ├─→ Claude Skill 触发
  ├─→ 命令行直接调用
  └─→ 定时任务自动执行 (21:00)
```

### 2. 参数解析阶段

```
解析输入参数
  │
  ├─→ 场景: 雨夜 / 樱花雨 / 赛博朋克 / ...
  ├─→ 情绪: 挑逗 / 忧郁 / 温柔 / ...
  ├─→ 妆容: 韩妆 / 欧美妆 / 裸妆 / ...
  ├─→ 风格: 王家卫 / 韩剧 / 电影感 / ...
  └─→ 光影: 黄金时刻 / 蓝调时刻 / 霓虹灯光 / ...
```

### 3. 主题与档案生成

```
获取当前日期 (YYYYMMDD)
  │
  ├─→ 计算星期几 (0-6)
  ├─→ 确定每日主题 (7种轮换)
  │     周一:多样化 周二:清新自然 周三:知性优雅
  │     周四:冷艳高冷 周五:可爱甜美 周六:时尚潮流 周日:温暖治愈
  │
  └─→ 日期种子随机
        ├─→ 面容特征 (3选1，当天固定)
        ├─→ 发型风格 (3选1，当天固定)
        └─→ 身材描述 (3选1，当天固定)
```

### 4. Prompt 构建阶段

```
Master Prompt 组装
  │
  ├─→ 基础质量: "masterpiece best quality ultra detailed 8K UHD"
  ├─→ 艺术风格: "Wong Kar-wai style, saturated colors..."
  ├─→ 主体描述: "portrait photography [面容] [发型] [身材]"
  ├─→ 妆容: "makeup: K-style makeup, gradient lips..."
  ├─→ 情绪: "emotion: seductive gaze, playful smirk..."
  ├─→ 服装: "wearing black lace dress deep V..."
  ├─→ 姿态: "extreme close-up portrait, seductive eyes..."
  ├─→ 场景: "scene: rainy night city street, neon lights..."
  ├─→ 光影: "lighting: blue hour, twilight blue sky..."
  └─→ 相机: "85mm f/1.2 ultra shallow DOF bokeh"
```

### 5. 图像生成阶段

```
┌─────────────────────────────────────────────────────────────┐
│ 图片1: 文生图 (TXT2IMG)                                     │
│   prompt → 豆包API → 图片URL1                                │
│        ↓                                                    │
│   作为参考图传递给后续图片                                  │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 图片2: 图生图 (IMG2IMG)                                     │
│   prompt + 图片URL1(参考图) → 豆包API → 图片URL2            │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ 图片3: 图生图 (IMG2IMG)                                     │
│   prompt + 图片URL1(参考图) → 豆包API → 图片URL3            │
└─────────────────────────────────────────────────────────────┘

⚠️ 图片仅保留在线URL，不保存到本地
```

### 6. 发布阶段

```
生成完成 (获得 3 个在线URL)
  │
  ├─→ 自动发布 (每天 21:00)
  │     │
  │     ├─→ launchd 定时触发
  │     ├─→ 生成配文
  │     ├─→ 构建小绿书格式
  │     ├─→ 调用微绿流量宝API
  │     └─→ 发布到「三更愿」草稿箱
  │
  └─→ 手动发布
        │
        ├─→ 用户主动触发
        │   ├─→ 命令行: publish_wechat.py
        │   ├─→ Claude Skill: "发布美女"
        │   ├─→ 生成配文
        │   ├─→ 构建小绿书格式
        │   ├─→ 调用微绿流量宝API
        │   └─→ 发布到「三更愿」草稿箱
        │
        └─→ 测试模式 (只生成不发布)
              └─→ publish_wechat.py --test
```

## 数据流图

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ 用户输入 │───▶│ 参数控制 │───▶│ 档案生成 │───▶│ Prompt  │───▶│ API调用  │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
                                                           │
                                                           ▼
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ 公众号   │◀───│ 获取URL │◀───│ 图片生成 │◀───│ 图生图   │◀───│ 返回URL  │
│  发布    │    │ (在线)  │    │          │    │          │    │ (豆包云) │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
   │
   ├─→ 自动 (21:00 定时)
   └─→ 手动 (用户触发)

⚠️ 图片仅保留在线URL，不保存到本地
```

## 定时发布流程

```
系统时钟 (21:00)
      │
      ▼
┌─────────────────┐
│ launchd 触发     │
│ auto_publish.py │
└─────────────────┘
      │
      ├─→ 检查API密钥
      ├─→ 获取今日主题
      ├─→ 调用 generate_beauty.py (3张)
      │      │
      │      └─→ 返回3个在线URL
      ├─→ 生成配文
      ├─→ 调用微绿流量宝API
      └─→ 发布到「三更愿」草稿箱
```

## 手动发布流程

```
用户触发
      │
      ├─→ 命令行: publish_wechat.py --count 3
      ├─→ Claude Skill: "发布美女"
      │
      ├─→ 调用 generate_beauty.py
      │      │
      │      └─→ 返回在线URL
      ├─→ 生成配文
      ├─→ 调用微绿流量宝API
      └─→ 发布到「三更愿」草稿箱
```

## 关键技术点

### 1. 人物一致性保证
- **日期种子**: 使用 `YYYYMMDD` 作为随机数种子，确保同一天选择相同的人物特征
- **图生图技术**: 第2、3张图片使用第1张作为参考图，大幅提升一致性

### 2. Prompt 工程
- **结构化组装**: 质量词 → 风格 → 主体 → 妆容 → 情绪 → 服装 → 姿态 → 场景 → 光影 → 相机
- **专业术语**: 使用摄影专业术语 (85mm, f/1.2, rim light, bokeh等)
- **Midjourney 风格**: 参考顶级 AI 绘图工具的 prompt 结构

### 3. 精准控制
- **场景系统**: 15+ 种精心设计的场景描述
- **情绪系统**: 8 种情绪表达，从微表情到肢体语言
- **妆容系统**: 8 种专业妆容风格
- **艺术风格**: 8 种艺术风格，从电影感到日系清新
- **光影系统**: 8 种专业光影方案

## 文件位置

```
~/.claude/skills/beauty-generator/
├── scripts/
│   ├── generate_beauty.py      # V4.0 主生成脚本
│   ├── publish_wechat.py       # 公众号发布
│   └── auto_publish.py         # 定时发布
├── logs/                       # 运行日志
└── config/                     # 配置文件

⚠️ 图片仅保留在线URL (豆包云)，不保存到本地
```
